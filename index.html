<!DOCTYPE html>

<html lang="fi">
<head>
  <meta charset="utf-8" />
  <title>Pirkanmaan viranomaistoimijat</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }

    #header {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 8px 16px;
      border-radius: 6px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.3);
      text-align: center;
    }

    #header h1 { margin: 0; font-size: 12px; font-weight: 500; }

    #controls {
      position: absolute;
      top: 70px;
      right: 10px;
      z-index: 1000;
      width: 260px;
    }

    .panel {
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.3);
      margin-bottom: 10px;
      font-size: 14px;
    }

    .panel h3 { margin: 0 0 6px 0; font-size: 14px; }
    .panel label { display: block; margin-bottom: 4px; }

    #legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 8px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.3);
      font-size: 13px;
    }

    .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
      margin-right: 6px;
    }

    .marker {
      width: 12px;
      height: 12px;
      border: 2px solid white;
      border-radius: 50%;
    }

    .pelastus-marker { background:red; }
    .poliisi-marker { background:blue; }
    .sairaala-marker { background:green; }
    .puolustusvoimat-marker { background:black; }
    .puolustusteollisuus-marker { background:rgb(249,232,0); }
    .tulli-marker { background:purple; }
    .rajavartiolaitos-marker { background:brown; }
    .liikenne-marker { background:gray; }
    .energia-marker { background:orange; }
    .vesihuolto-marker { background:teal; }
  </style>

</head>
<body>

<div id="header">
  <h1><b>Pirkanmaan viranomaistoimijat</b></h1>
  <div id="subtitle">SOJO viranomaisyhteistyötehtävä</div>
</div>

<div id="controls">
  <div class="panel">
    <h3>Viranomaiset</h3>
    <button id="selectAll">Näytä kaikki</button>
    <button id="deselectAll">Piilota kaikki</button>
    <div id="typeFilters"></div>
  </div>

  <div class="panel">
    <h3>Kunta</h3>
    <select id="municipalityFilter">
      <option value="">Kaikki kunnat</option>
    </select>
  </div>
</div>

<div id="legend"></div>
<div id="map"></div>

<script>
  const DATASETS = [
    { key:'pelastus', url:'pelastustoimi.json', label:'Pelastustoimi', css:'pelastus-marker' },
    { key:'poliisi', url:'poliisi.json', label:'Poliisi', css:'poliisi-marker' },
    { key:'sairaala', url:'hva.json', label:'Sairaala / hoitoyksikkö', css:'sairaala-marker' },
    { key:'puolustusvoimat', url:'puolustusvoimat.json', label:'Puolustusvoimat', css:'puolustusvoimat-marker' },
    { key:'puolustusteollisuus', url:'puolustusteollisuus.json', label:'Puolustusteollisuus', css:'puolustusteollisuus-marker' },
    { key:'tulli', url:'tulli.json', label:'Tulli', css:'tulli-marker' },
    { key:'rajavartiolaitos', url:'rajavartiolaitos.json', label:'Rajavartiolaitos', css:'rajavartiolaitos-marker' },
    { key:'liikenne', url:'liikenne.json', label:'Liikenne', css:'liikenne-marker' },
    { key:'energia', url:'energia.json', label:'Energia', css:'energia-marker' },
    { key:'vesihuolto', url:'vesihuolto.json', label:'Vesihuolto', css:'vesihuolto-marker' }
  ];

  const map = L.map('map').setView([61.7, 23.7], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

  function createIcon(css) {
    return L.divIcon({ className: 'marker ' + css, iconSize: [12, 12] });
  }

  const icons = {}, layers = {}, allMarkers = [], municipalities = {};

  DATASETS.forEach(d => {
    icons[d.key] = createIcon(d.css);
    layers[d.key] = L.layerGroup().addTo(map);
  });

  function addMarker(p, d) {
    if (p.lat == null || p.lon == null) return;

    const m = L.marker([p.lat, p.lon], { icon: icons[d.key] });

    m.bindPopup(`
      <strong>${p.nimi}</strong><br>
      ${p.kunta}<br>
      <em>${d.label}</em><br><br>
      ${p.paatehtavat ? `<strong>Päätehtävät:</strong><br>${p.paatehtavat}<br><br>` : ''}
      ${p.maanpuolustusmerkitys ? `<strong>Maanpuolustusmerkitys:</strong><br>${p.maanpuolustusmerkitys}` : ''}
    `);

    m.datasetKey = d.key;
    m.municipality = p.kunta;

    m.addTo(layers[d.key]);
    allMarkers.push(m);
    municipalities[p.kunta] = true;
  }

  let loaded = 0;

  function loadDataset(d) {
    fetch(d.url)
      .then(r => r.json())
      .then(json => {
        const arr = Array.isArray(json) ? json : json.kohteet;
        if (!arr) return;
        arr.forEach(p => addMarker(p, d));
      })
      .finally(() => {
        loaded++;
        if (loaded === DATASETS.length) {
          initFilters();
          buildLegend();
          fitAll();
        }
      });
  }

  DATASETS.forEach(loadDataset);

  function initFilters() {
    const c = document.getElementById('typeFilters');
    DATASETS.forEach(d => {
      const l = document.createElement('label');
      l.innerHTML = `<input type="checkbox" id="chk-${d.key}" checked> ${d.label}`;
      c.appendChild(l);
      document.getElementById(`chk-${d.key}`).onchange = applyFilters;
    });

    document.getElementById('selectAll').onclick = () => setAllTypes(true);
    document.getElementById('deselectAll').onclick = () => setAllTypes(false);

    const sel = document.getElementById('municipalityFilter');
    Object.keys(municipalities).sort().forEach(k => {
      const o = document.createElement('option');
      o.value = k;
      o.textContent = k;
      sel.appendChild(o);
    });
    sel.onchange = applyFilters;
  }

  function setAllTypes(v) {
    DATASETS.forEach(d => document.getElementById(`chk-${d.key}`).checked = v);
    applyFilters();
  }

  function applyFilters() {
    const active = {};
    const mun = document.getElementById('municipalityFilter').value;

    DATASETS.forEach(d => {
      if (document.getElementById(`chk-${d.key}`).checked) active[d.key] = true;
    });

    allMarkers.forEach(m => {
      const show = active[m.datasetKey] && (!mun || m.municipality === mun);
      if (show) m.addTo(layers[m.datasetKey]);
      else layers[m.datasetKey].removeLayer(m);
    });
  }

  function buildLegend() {
    const l = document.getElementById('legend');
    l.innerHTML = '<strong>Värikoodien selitykset</strong><br>';
    DATASETS.forEach(d => {
      l.innerHTML += `<div class="legend-item"><div class="legend-dot ${d.css}"></div>${d.label}</div>`;
    });
  }

  function fitAll() {
    if (allMarkers.length) map.fitBounds(L.featureGroup(allMarkers).getBounds(), { padding: [20,20] });
  }
</script>

</body>
</html>
