<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <title>Pirkanmaan viranomaistoimijat</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { position:absolute; top:0; left:0; right:0; bottom:120px; }

    #header {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 8px 16px;
      border-radius: 6px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.3);
      text-align: center;
    }

    #header h1 { margin: 0; font-size: 12px; font-weight: 500; }

    #controls {
      position: absolute;
      top: 70px;
      right: 10px;
      z-index: 1000;
      width: 260px;
    }

    .panel {
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.3);
      margin-bottom: 10px;
      font-size: 14px;
    }

    .panel h3 { margin: 0 0 6px 0; font-size: 14px; }
    .panel label { display: block; margin-bottom: 4px; cursor: pointer; }

    #legend {
      position: absolute;
      top: 110px;
      left: 10px;
      z-index: 900;
      background: rgba(255,255,255,0.95);
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.3);
      font-size: 13px;
    }

    .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
      margin-right: 6px;
    }

    .marker { width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; }
    .energia-marker { background:orange; }
    .kunnat-marker { background:rgb(74,78,61); }
    .seurakunnat-marker { background:rgb(138,43,226); }
    .liikenne-marker { background:gray; }
    .pelastus-marker { background:red; }
    .poliisi-marker { background:blue; }
    .puolustusvoimat-marker { background:black; }
    .puolustusteollisuus-marker { background:rgb(249,232,0); }
    .sairaala-marker { background:green; }
    .rajavartiolaitos-marker { background:brown; }
    .tulli-marker { background:purple; }
    .vesihuolto-marker { background:teal; }

    #bottomBar {
      position:absolute;
      bottom:0; left:0; right:0;
      height:140px;
      background: rgba(255,255,255,0.95);
      color:#000;
      overflow-y:auto;
      padding:10px 14px;
      box-sizing:border-box;
      z-index:1000;
      box-shadow:0 -2px 6px rgba(0,0,0,0.25);
    }

    #bottomBar table { width:100%; border-collapse:collapse; font-size:13px; }
    #bottomBar th, #bottomBar td { border-bottom:1px solid #ccc; padding:6px 8px; text-align:left; }
    #bottomBar th { font-weight:600; color:#000; }
  </style>
</head>
<body>

<div id="header">
  <h1>Pirkanmaan viranomaistoimijat</h1>
  <div id="subtitle">Etätehtävä</div>
</div>

<div id="controls">
  <div class="panel">
    <h3>Viranomaiset</h3>
    <button id="selectAll">Näytä kaikki</button>
    <button id="deselectAll">Piilota kaikki</button>
    <div id="typeFilters"></div>
  </div>

  <div class="panel">
    <h3>Kunta</h3>
    <select id="municipalityFilter">
      <option value="">Kaikki kunnat</option>
    </select>
  </div>
</div>

<div id="legend"></div>
<div id="map"></div>
<div id="bottomBar"></div>

<script>
  const DATASETS = [
    { key:'energia', url:'energia.json', label:'Energia', css:'energia-marker' },
    { key:'kunnat', url:'kaupungit_kunnat.json', label:'Kaupungit ja kunnat', css:'kunnat-marker' },
    { key:'seurakunnat', url:'seurakunnat.json', label:'Seurakunnat', css:'seurakunnat-marker' },
    { key:'liikenne', url:'liikenne.json', label:'Liikenne', css:'liikenne-marker' },
    { key:'pelastus', url:'pelastustoimi.json', label:'Pelastustoimi', css:'pelastus-marker' },
    { key:'poliisi', url:'poliisi.json', label:'Poliisi', css:'poliisi-marker' },
    { key:'puolustusvoimat', url:'puolustusvoimat.json', label:'Puolustusvoimat', css:'puolustusvoimat-marker' },
    { key:'puolustusteollisuus', url:'puolustusteollisuus.json', label:'Puolustusteollisuus', css:'puolustusteollisuus-marker' },
    { key:'terveydenhuolto', url:'hva.json', label:'Terveydenhuolto', css:'sairaala-marker' },
    { key:'rajavartiolaitos', url:'rajavartiolaitos.json', label:'Rajavartiolaitos', css:'rajavartiolaitos-marker' },
    { key:'tulli', url:'tulli.json', label:'Tulli', css:'tulli-marker' },
    { key:'vesihuolto', url:'vesihuolto.json', label:'Vesihuolto', css:'vesihuolto-marker' }
  ];

  const map = L.map('map').setView([61.7, 23.7], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

  const icons = {}, layers = {}, allMarkers = [], municipalities = new Set(), counts = {};

  function createIcon(css) {
    return L.divIcon({ className:'marker '+css, iconSize:[12,12] });
  }

  DATASETS.forEach(d => {
    icons[d.key] = createIcon(d.css);
    layers[d.key] = L.layerGroup().addTo(map);
    counts[d.key] = 0;
  });

  function addMarker(p, d) {
    if (p.lat == null || p.lon == null) return;

    const m = L.marker([p.lat, p.lon], { icon: icons[d.key] });
    m._meta = { nimi: p.nimi || '', kunta: p.kunta || '' };

    m.bindPopup(`
      <strong>${m._meta.nimi}</strong><br>
      ${m._meta.kunta}<br>
      <em>${d.label}</em><br><br>
      ${p.paatehtavat ? `<strong>Päätehtävät:</strong><br>${p.paatehtavat}<br><br>` : ''}
      ${p.maanpuolustusmerkitys ? `<strong>Maanpuolustusmerkitys:</strong><br>${p.maanpuolustusmerkitys}` : ''}
    `);

    m.datasetKey = d.key;
    m.municipality = m._meta.kunta;

    m.addTo(layers[d.key]);
    allMarkers.push(m);
    if (m._meta.kunta) municipalities.add(m._meta.kunta);
    counts[d.key]++;
  }

  let loaded = 0;

  function loadDataset(d) {
    fetch(d.url)
      .then(r => r.json())
      .then(json => {
        const arr = Array.isArray(json) ? json : json.kohteet || [];
        arr.forEach(p => addMarker(p, d));
      })
      .finally(() => {
        loaded++;
        if (loaded === DATASETS.length) {
          initFilters();
          buildLegend();
          applyFilters();
          fitAll();
        }
      });
  }

  DATASETS.forEach(loadDataset);

  function initFilters() {
    const c = document.getElementById('typeFilters');
    DATASETS.forEach(d => {
      const l = document.createElement('label');
      l.innerHTML = `<input type="checkbox" id="chk-${d.key}" checked> ${d.label} (${counts[d.key]})`;
      c.appendChild(l);
      document.getElementById(`chk-${d.key}`).onchange = applyFilters;
    });

    document.getElementById('selectAll').onclick = () => setAllTypes(true);
    document.getElementById('deselectAll').onclick = () => setAllTypes(false);

    const sel = document.getElementById('municipalityFilter');
    [...municipalities].sort().forEach(k => {
      const o = document.createElement('option');
      o.value = k;
      o.textContent = k;
      sel.appendChild(o);
    });
    sel.onchange = applyFilters;
  }

  function setAllTypes(v) {
    DATASETS.forEach(d => document.getElementById(`chk-${d.key}`).checked = v);
    applyFilters();
  }

  function applyFilters() {
    const active = {};
    const mun = document.getElementById('municipalityFilter').value;

    DATASETS.forEach(d => {
      if (document.getElementById(`chk-${d.key}`).checked) active[d.key] = true;
    });

    const visible = [];
    allMarkers.forEach(m => {
      const show = active[m.datasetKey] && (!mun || m.municipality === mun);
      if (show) {
        m.addTo(layers[m.datasetKey]);
        visible.push(m);
      } else {
        layers[m.datasetKey].removeLayer(m);
      }
    });

    updateBottomBar(visible);
  }

  function buildLegend() {
    const l = document.getElementById('legend');
    l.innerHTML = '<strong>Värikoodien selitykset</strong><br>';
    DATASETS.forEach(d => {
      l.innerHTML += `<div class="legend-item"><div class="legend-dot ${d.css}"></div>${d.label}</div>`;
    });
  }

  function updateBottomBar(markers) {
    const bar = document.getElementById('bottomBar');
    if (!markers.length) {
      bar.innerHTML = '<em>Ei valittuja kohteita</em>';
      return;
    }

    let html = '<table><thead><tr><th>Nimi</th><th>Kunta</th></tr></thead><tbody>';
    markers.forEach(m => {
      html += `<tr title="Klikkaa kohdetta kartalla"><td>${m._meta.nimi}</td><td>${m._meta.kunta}</td></tr>`;
    });
    html += '</tbody></table>';
    bar.innerHTML = html;
  }

  function fitAll() {
    if (allMarkers.length) {
      map.fitBounds(L.featureGroup(allMarkers).getBounds(), { padding:[20,20] });
    }
  }
</script>
</body>
</html>
