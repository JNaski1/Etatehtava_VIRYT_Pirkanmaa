<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <title>Pirkanmaan viranomaistoimijat</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js">function getColor(cssClass) {
    var colors = {
      'pelastus-marker': 'red',
      'poliisi-marker': 'blue',
      'sairaala-marker': 'green',
      'puolustusvoimat-marker': 'black',
      'puolustusteollisuus-marker': '#f9e800',
      'tulli-marker': 'purple',
      'rajavartiolaitos-marker': 'brown',
      'liikenne-marker': 'gray',
      'energia-marker': 'orange',
      'vesihuolto-marker': 'teal'
    };
    return colors[cssClass] || 'black';
  }

</script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }

    /* ===== HEADER ===== */
    #header {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 8px 16px;
      border-radius: 6px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.3);
      text-align: center;
    }

    #header h1 { margin: 0; font-size: 18px; }
    #subtitle { margin-top: 4px; font-size: 13px; color: #444; }

    /* ===== CONTROLS ===== */
    #controls {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      width: 260px;
    }

    .panel {
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.3);
      margin-bottom: 10px;
      font-size: 14px;
    }

    .panel h3 { margin: 0 0 6px 0; font-size: 14px; }
    .panel label { display: block; margin-bottom: 4px; }

    .panel-actions { margin-bottom: 6px; }
    .panel-actions button { margin-right: 4px; }

    /* ===== LEGEND ===== */
    #legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 8px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.3);
      font-size: 13px;
    }

    .legend-item { display: flex; align-items: center; margin-bottom: 4px; }

    /* legend-dot käyttää samaa marker-logiikkaa */
    .legend-dot {
      width: 12px;
      height: 12px;
      border: 2px solid white;
      border-radius: 50%;
      margin-right: 6px;
    }

    /* ===== MARKERIT (YHTENÄINEN) ===== */
    .marker {
      width: 12px;
      height: 12px;
      border: 2px solid white;
      border-radius: 50%;
      pointer-events: auto;
    }

    .pelastus-marker { background:red; }
    .poliisi-marker { background:blue; }
    .sairaala-marker { background:green; }
    .puolustusvoimat-marker { background:black; }
    .puolustusteollisuus-marker { background:rgb(249,232,0); }
    .tulli-marker { background:purple; }
    .rajavartiolaitos-marker { background:brown; }
    .liikenne-marker { background:gray; }
    .energia-marker { background:orange; }
    .vesihuolto-marker { background:teal; }
  </style>
</head>
<body>

<div id="header">
  <h1>Pirkanmaan viranomaistoimijat</h1>
  <div id="subtitle">Viranomaisyhteistyötehtävä</div>
</div>

<div id="controls">
  <div class="panel">
    <h3>Viranomaiset</h3>
    <div class="panel-actions">
      <button type="button" id="selectAll">Näytä kaikki</button>
      <button type="button" id="deselectAll">Piilota kaikki</button>
    </div>
    <div id="typeFilters"></div>
  </div>

  <div class="panel">
    <h3>Kunta</h3>
    <select id="municipalityFilter">
      <option value="">Kaikki kunnat</option>
    </select>
  </div>
</div>

<div id="legend"></div>
<div id="map"></div>

<script>
  /* ============================== */
  /* DATASETS */
  /* ============================== */
  var DATASETS = [
    { key:'pelastus', url:'pelastustoimi.json', label:'Pelastustoimi', css:'pelastus-marker' },
    { key:'poliisi', url:'poliisi.json', label:'Poliisi', css:'poliisi-marker' },
    { key:'sairaala', url:'hva.json', label:'Sairaala / hoitoyksikkö', css:'sairaala-marker' },
    { key:'puolustusvoimat', url:'puolustusvoimat.json', label:'Puolustusvoimat', css:'puolustusvoimat-marker' },
    { key:'puolustusteollisuus', url:'puolustusteollisuus.json', label:'Puolustusteollisuus', css:'puolustusteollisuus-marker' },
    { key:'tulli', url:'tulli.json', label:'Tulli', css:'tulli-marker' },
    { key:'rajavartiolaitos', url:'rajavartiolaitos.json', label:'Rajavartiolaitos', css:'rajavartiolaitos-marker' },
    { key:'liikenne', url:'liikenne.json', label:'Liikenne', css:'liikenne-marker' },
    { key:'energia', url:'energia.json', label:'Energia', css:'energia-marker' },
    { key:'vesihuolto', url:'vesihuolto.json', label:'Vesihuolto', css:'vesihuolto-marker' }
  ];

  /* ============================== */
  /* KARTTA */
  /* ============================== */
  var map = L.map('map').setView([61.7,23.7],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap' }).addTo(map);

  
  var icons = {}; // ei käytössä enää, circleMarker ei tarvitse ikoneita
  var layers = {};
  var allMarkers = [];
  var municipalities = {};

  for(var i=0;i<DATASETS.length;i++){
    layers[DATASETS[i].key] = L.layerGroup().addTo(map);
  }

  /* ============================== */
  /* MARKERIT */
  /* ============================== */
  function buildTooltip(p, d){
    return '<strong>' + p.nimi + '</strong><br>' +
           p.kunta + '<br>' +
           '<em>' + d.label + '</em>';
  }


  function addMarker(p, d){
    if (p.lat === undefined || p.lon === undefined) return;

    var m = L.circleMarker([p.lat, p.lon], {
      radius: 6,
      color: '#ffffff',
      weight: 2,
      fillColor: getColor(d.css),
      fillOpacity: 1
    }).bindTooltip(buildTooltip(p, d), {
      direction: 'top',
      offset: [0, -6],
      opacity: 0.95,
      sticky: true
    });

    m.datasetKey = d.key;
    m.municipality = p.kunta;

    m.addTo(layers[d.key]);
    allMarkers.push(m);
    municipalities[p.kunta] = true;
  }

  /* ============================== */
  /* DATA LATAUS */
  /* ============================== */
  var loaded = 0;

  function loadDataset(d){
    fetch(d.url)
      .then(r => r.json())
      .then(json => {
        var arr = Array.isArray(json) ? json : json.kohteet;
        if(!arr) return;
        for(var i=0;i<arr.length;i++) addMarker(arr[i], d);
      })
      .finally(() => {
        loaded++;
        if(loaded === DATASETS.length){
          initFilters();
          buildLegend();
          fitAll();
        }
      });
  }

  for(var i=0;i<DATASETS.length;i++) loadDataset(DATASETS[i]);

  /* ============================== */
  /* FILTTERIT – VAIN MARKERIT */
  /* ============================== */
  function initFilters(){
    initTypeFilters();
    initMunicipalityFilter();
  }

  function initTypeFilters(){
    var c = document.getElementById('typeFilters');
    c.innerHTML = '';

    for(var i=0;i<DATASETS.length;i++){
      var d = DATASETS[i];
      var l = document.createElement('label');
      l.innerHTML = '<input type="checkbox" id="chk-'+d.key+'" checked> '+d.label;
      c.appendChild(l);
      document.getElementById('chk-'+d.key).onchange = applyFilters;
    }

    document.getElementById('selectAll').onclick = function(){ setAllTypes(true); };
    document.getElementById('deselectAll').onclick = function(){ setAllTypes(false); };
  }

  function initMunicipalityFilter(){
    var sel = document.getElementById('municipalityFilter');
    sel.innerHTML = '<option value="">Kaikki kunnat</option>';

    var keys = Object.keys(municipalities).sort();
    for(var i=0;i<keys.length;i++){
      var o = document.createElement('option');
      o.value = keys[i];
      o.textContent = keys[i];
      sel.appendChild(o);
    }

    sel.onchange = applyFilters;
  }

  function setAllTypes(val){
    for(var i=0;i<DATASETS.length;i++){
      document.getElementById('chk-'+DATASETS[i].key).checked = val;
    }
    applyFilters();
  }

  function applyFilters(){
    var activeTypes = {};
    var mun = document.getElementById('municipalityFilter').value;

    for(var i=0;i<DATASETS.length;i++){
      var id = 'chk-'+DATASETS[i].key;
      if(document.getElementById(id).checked) activeTypes[DATASETS[i].key] = true;
    }

    // markerit lisätään/poistetaan, layerit pysyvät aina päällä
    for(var i=0;i<allMarkers.length;i++){
      var m = allMarkers[i];
      var show = activeTypes[m.datasetKey] && (!mun || m.municipality === mun);
      if(show) m.addTo(layers[m.datasetKey]);
      else layers[m.datasetKey].removeLayer(m);
    }
  }

  /* ============================== */
  /* LEGENDA */
  /* ============================== */
  function buildLegend(){
    var l = document.getElementById('legend');
    l.innerHTML = '<strong>Värikoodien selitykset</strong><br>';

    for(var i=0;i<DATASETS.length;i++){
      var d = DATASETS[i];
      l.innerHTML += '<div class="legend-item"><div class="legend-dot marker '+d.css+'"></div>'+d.label+'</div>';
    }
  }

  /* ============================== */
  /* ZOOM */
  /* ============================== */
  function fitAll(){
    if (allMarkers.length) {
      map.fitBounds(L.featureGroup(allMarkers).getBounds(), { padding: [20, 20] });
    }
    setTimeout(function () {
      map.invalidateSize();
    }, 0);
  }

</script>
</body>
</html>
